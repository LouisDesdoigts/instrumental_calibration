% Define document class
\documentclass[twocolumn]{spie}
% \documentclass[twocolumn]{aastex631}
\usepackage[utf8]{inputenc}
\usepackage{showyourwork}
\usepackage{xspace}
%\documentclass[a4paper]{spie}  %>>> use this instead for A4 paper
%\documentclass[nocompress]{spie}  %>>> to avoid compression of citations

\renewcommand{\baselinestretch}{1.0} % Change to 1.65 for double spacing
\usepackage{amsmath,amsfonts,amssymb}
\usepackage{graphicx}
\usepackage[colorlinks=true, allcolors=blue]{hyperref}
\usepackage{hyperref}
\usepackage{relsize}
\usepackage{acro}
\acsetup{
  single    = false,
  list/sort  = true,
  cite/group = true,
  cite/group/cmd = \cite,
  cite/group/pre = {},
}

\DeclareAcronym{prf}{
  short = PRF,
  long = Pixel Response Function
}

\DeclareAcronym{psf}{
  short = PSF,
  long = Point Spread Function
}

\DeclareAcronym{gpu}{
  short = GPU,
  long = Graphics Processing Unit
}

\DeclareAcronym{hmc}{
  short = HMC,
  long = Hamiltonian Monte Carlo,
  cite = {Betancourt2017}
}

\DeclareAcronym{mcmc}{
  short = MCMC,
  long = Markov Chain Monte Carlo,
  cite = {Metropolis1953}
}

\DeclareAcronym{gp}{
  short = GP,
  long = Gaussian Process,
  cite = {rasmussen:williams:2006}
}

\DeclareAcronym{snr}{
  short = SNR,
  long = signal-to-noise ratio
}



% \newcommand\jax{\textsc{Jax}\xspace}
\newcommand\dlux{$\partial$Lux\xspace}

% \title{Differentiable Optics with {\Large $\partial$}Lux: I - Deep Calibration of Flat Field and Phase with Automatic Differentiation}
\title{Differentiable Optics with dLux: I - Deep Calibration of Flat Field and Phase with Automatic Differentiation}



\affil[a]{Sydney Institute for Astronomy, School of Physics, University of Sydney, NSW~2006, Australia}
\affil[b]{School of Mathematics and Physics, University of Queensland, St Lucia, QLD~4072, Australia}
\affil[c]{Centre for Astrophysics, University of Southern Queensland, West Street, Toowoomba, QLD~4350, Australia}

\author[a]{Louis C. Desdoigts}
\author[b]{Benjamin J. S. Pope}
\author[a]{Peter G. Tuthill}

% Begin!
\authorinfo{Send correspondence to L. C. D.: \\E-mail: \href{mailto:louis.desdoigts@sydney.edu.au}{louis.desdoigts@sydney.edu.au}}

% Option to view page numbers
\pagestyle{empty} % change to \pagestyle{plain} for page numbers   
% \setcounter{page}{301} % Set start page numbering at e.g. 301
 
\begin{document} 
\maketitle

% Title

% Author list


% Abstract with filler text
\begin{abstract}
Stuff about \dlux

\end{abstract}

\section{Introduction}
\label{sec:intro}

% High precision astronomy is limited by systematics introduced by the optics and detector
At the bleeding edge of space-based astronomical imaging, photometry, and spectroscopy, the precision is limited by systematics introduced by aberrations in the optics and noise processes in the detector. While problems are ubiquitous in astronomy, we are motivated by several core examples. In exoplanet direct imaging, we want to achieve high resolution and high contrast simultaneously with instruments like JWST Coronagraphy \cite{Girard2022}, Aperture Masking \cite{Sivaramakrishnan2022}, or Kernel Phase \cite{Kammerer2022} modes. The astrometric mission Toliman \cite{tuthill2018} aims to measure precise relative positions of the binary stars $\alpha$~Centauri~AB to reveal the gravitational influence of unseen planets; this will require micro-arcsecond, micro-pixel astrometric precision. We may also want to perform high precision photometry, whether with dedicated missions like \textit{Kepler} \cite{Borucki2010} and TESS \cite{Ricker2015}, or as ancillary science with Toliman. 

In each case, we face serious limitations from an imperfect knowledge of the \ac{prf}, the map of the intra-pixel and inter-pixel variations in detector sensitivity; and the \ac{psf}, the diffraction-limited pattern by which light from a point source like a star is spatially spread out across a detector.

In this series of papers, we present a new software package, \dlux, for fitting high-dimensional parametrized physical optics models to astronomical data. By using the Python library \textsc{Jax}\cite{jax}, we obtain \ac{gpu} hardware acceleration, as well as automatic differentiation\cite{Margossian2018} features that enable high dimensional optimization and inference with gradient descent or \ac{hmc}. In the present paper, we focus on the particular problem of estimating the \ac{prf} and \ac{psf} simultaneously - i.e. joint flat field calibration and phase retrieval. In Paper II, we will show how automatic differentiation enables improvements to hardware \textit{design}, directly calculating and optimizing the Fisher information and therefore fundamental figures of merit of an optical system end-to-end. We make \dlux available as open-source software on GitHub\footnote{\href{https://github.com/LouisDesdoigts/dLux}{github.com/LouisDesdoigts/dLux}}, and encourage interested readers to use and contribute to this package as a community resource. This paper has been compiled using ShowYourWork \cite{Luger2021}, so that all figures link to the code used to produce them.

\subsection{Phase Retrieval}
% PSFs
The \ac{psf} depends on the successive planes through which light passes from the entrance pupil of the telescope through to the detector. This can be calculated from physical optics: for a simple camera bringing light from the pupil to focus at a detector plane, the \ac{psf} is the Fourier transform of the input wavefront, the regime of Fraunhofer diffraction. In the more general Fresnel regime where the detector is slightly out of focus, there are additional quadratic phase factors before and after this Fourier transform. In more complicated instruments like coronagraphs \cite{Bowler2016}, the light might pass through multiple re-imaged pupil and focal planes, being operated on in each. In either case, the trouble is that the \ac{psf} is distorted by unknown aberrations - distortions in the wavefront, which can be represented as a spatially-varying phase map across the optical plane. 

% Phase Retrieval - G-S, Fienup, review papers, kernel phase
Phase retrieval is the problem of inferring these aberrations from data\cite{schechtman2014}, which is in general ill-posed \cite{barnett2020}: because of the Hermitian symmetry of the Fourier transform, and because we measure \textit{intensity} and not electric field in optical astronomy, there is a large space of aberrations that would generate the same intensity \ac{psf}. Fortunately, this space can be restricted to physically-realistic solutions and readily solved by algorithms such as the Gerchberg-Saxton algorithm \cite{gerchberg1972}, using ideas from compressed sensing \cite{candes2011}, or by machine learning \cite{metzler2018,isil2019,nishizaki2020}.  Phase retrieval was memorably performed to infer and correct the serious aberration on the \textit{Hubble Space Telescope} mirror at launch \cite{hubble_phase_ret}. 
Earlier work in the vein of this paper has shown that the phase retrieval problem can be efficiently solved by taking a forwards model of physical optics, obtaining partial derivatives with automatic differentiation, and optimizing its parameters by gradient descent \cite{jurling_fienup,phase_ret_and_design}.

\subsection{Detector Calibration}

High-precision, high-cadence time series of space photometry from \textit{Kepler} \cite{Borucki2010}, K2 \cite{K2}, TESS \cite{TESS} and CHEOPS \cite{CHEOPS} space telescopes have been revolutionary for exoplanetary science \cite{Zhu2021} and stellar astrophysics \cite{Aerts21,Jackiewicz2021}. 

% Photometry is hard because of flat field & optical aberrations
In many practical cases, photometric precision is limited by systematic errors due to variations in sensitivity within and between pixels. Changes in telescope pointing or PSF couple to these inter- and intra-pixel variations in the flat field. This was particularly severe for the K2 mission where the breakdown of two reaction wheels in the original Kepler mission necessitated the telescope pointing be maintained with periodic thruster firings. This pointing instability introduced a saw-tooth systematic on 6 hour timescales, comparable to the timescales of exoplanet transits and asteroseismic signals of interest. Similarly, throughout one Earth orbit telescopes experience a changing thermal gradient across the optical train as one side faces the Sun, and the other deep space. Depending on the orbital height, this introduces periodic optical aberrations that distort the PSF over timescales of interest. The systematic coupling of these effects has given rise to many methods used to either de-correlate these signals or calibrate the systematics. 

%  flat field calibration
Much work has been put towards developing data-driven self-calibration of the flat field in K2, which are of general interest and applicability for other space photometry missions. 
% 		- self-flat fielding (Andrew Vanderburg) 
In  `self flat-fielding' (K2SFF\cite{self_flat-fielding}), the light curve is decorrelated against principal components of all light curves on the detector. Time-series photometric signals that correlate with source position are then used to isolate the signal introduced by pixel sensitivity variation and correct for it.
%       - dun wang causal pixel model 
Taking a similar approach \citet{causal_pixel} constrains instrumental effects by measuring correlations in the light curves of causally uncorrelated pixels.
% 		- Christina Hedges (pixel cal papers) ??
% 		- Luger papers (pixel-level decorrelation)
In \citet{pixel_decorr} ... 
% 		- halo photometry (white, pope)
Other non-linear instrumental effects such as saturation can further complicate the recovery of precise light curves. Halo photometry \citep{halo, halo2} sidesteps the saturation problem by extracting light curves from the `halo' of scattered light around the saturated pixels. Instrumental and astrophysical effects are separated by assigning individual pixel weights and biases, which are optimised in order to maximise correlation the between pixel light-curves within the same halo, and minimise correlations between pixels light curves across different halos.

% Pixel Sensitivities - Photometry
% K2
% K2SFF
% K2SC
% EVEREST
% OWL/HALO
% CPM
% LSST
% Pixel Sensitivities - Imaging
% Euclid
% JWST AMI 


\section{\dlux Differentiable Optical Models}
\label{sec:dlux}
\textcolor{red}{Louis - this is your bit to write!}
% Physical Optics Forwards Models
% poppy/WebbPSF
% Autodiff
% Review backprop/NNs
% Jax, PyTorch, Julia
% Autodiff Optics
% WaveBlocks
% Sitzmann etc
% Liaudat
% Morphine
% Overview of Wong et al 2021
% dLux
% Equinox
% Features
% Example of how to set up a model from layers

% Figure 1: (Hand-drawn?) Illustration of the Optical System & âˆ‚Lux model layers


\section{Phase Retrieval and Flat Field Estimation}
\label{sec:phaseretrieval}
% Describe simulation setup
% Figure 2: OPD & Pupil in our test, PSF, Flat Field histogram

% Describe gradient descent implementation & scheduling
% Takes X time on Y machine with Z precision on params (numbers from ShowYourWork)

% Figure showing results

% Figure 3: Like final 2l figures of tutorial merged together: 
% Top: loss function vs epoch
% Middle: correlation plot of Zernikes (with residual below); PSF (true, recovered, residual)
% Bottom: correlation plot of star fluxes (with residual below), correlation plot of sensitivities (with residual below), 2d residual map of pixels


\section{Discussion}
% Can this break down?
% Nyquist?
% Low photon SNR limit?
% Dithering or N stars requirement

\section{Conclusions \& Future Work}
% Review outcomes
% Useful for space photometry in crowded fields
% Toliman Pleiades?
% Useful for detector calibration & monitoring
% JWST, Roman
% Time series: regularize with GP?



% \begin{figure}[ht!]
%     \script{gen_optics.py}
%     \begin{centering}
%         \includegraphics[width=\linewidth]{figures/optics.pdf}
%         \caption{
%             The optics
%         }
%         \label{fig:optics}
%     \end{centering}
% \end{figure}

\section{Acknowledgements}

We acknowledge and pay respect to the Gadigal people of the Eora Nation, upon whose unceded, sovereign, ancestral lands the University of Sydney is built; and the traditional owners of the land on which the University of Queensland is situated, the Turrbal and Jagera people. We pay respects to their Ancestors and descendants, who continue cultural and spiritual connections to Country. 

This research made use of \textsc{Numpy} \cite{numpy}; SciPy \cite{scipy}; Matplotlib \cite{matplotlib}; Astropy \cite{astropy:2013,astropy:2018}; \textsc{Jax} \cite{jax}; and \texttt{equinox} \cite{kidger2021equinox}.

\bibliographystyle{spiebib} % makes bibtex use spiebib.bst
\bibliography{bib}

\end{document}
